name: "linux"
version: "6.18.3"
release: "7"
description: "The Linux kernel and headers"
sources:
  - "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$version.tar.xz"
  - "https://github.com/projg2/fedora-kernel-config-for-gentoo/raw/6.7.10-gentoo/kernel-x86_64-fedora.config"
  - "settings.config"
sha256sum:
  - "7a8879167b89c4bae077d6f39c4f2130769f05dbdad2aad914adab9afb7d7f9a"
  - "62cda75cb56faa94551e14200f4dff00e27ea30189d5399c3ce863ef2ba2b4b3"
  - "04f33434bb1b16b2a38e3a36d6ce59e0bf032db6954d4a71d07d8f3f5ab37e4c"
depends:
  - "kmod"
build_depends:
  - "flex"
  - "elfutils"
  - "xz-utils"
  - "gmake"

prepare {
  exec "tar -xvf linux-$version.tar.xz"
  cd "linux-$version"
  exec "make mrproper"
  exec "./scripts/kconfig/merge_config.sh -m ../kernel-x86_64-fedora.config ../settings.config || exit 1"
  exec "make olddefconfig"
}

func build_linux_headers {
  cd "linux-$version"
  exec "make mrproper"
  exec "make headers"
  exec "find usr/include -name '.*' -delete"
  exec "rm usr/include/Makefile"
}

package_linux_headers {
  cd "linux-$version"
  exec "mkdir -p $ROOT/usr"
  exec "cp -rv usr/include $ROOT/usr/"
}

func build_aarch64_linux_gnu_linux_headers {
  cd "linux-$version"
  exec "make ARCH=arm64 mrproper"
  exec "make ARCH=arm64 headers"
  exec "find usr/include -name '.*' -delete"
  exec "rm usr/include/Makefile"
}

package_aarch64_linux_gnu_linux_headers {
  exec "TARGET=\"aarch64-linux-gnu\""
  cd "linux-$version"
  exec "mkdir -p $ROOT/usr/aarch64-linux-gnu"
  exec "cp -rv usr/include/ $ROOT/usr/aarch64-linux-gnu"
}

build {
  cd "linux-$version"
  exec "make -j$(nproc) || exit 1"
}

package {
  cd "linux-$version"
  env INSTALL_MOD_PATH="$ROOT/usr"
  env INSTALL_PATH="$ROOT/boot"
  exec "mkdir -p \"$INSTALL_PATH\" \"$INSTALL_MOD_PATH\""
  exec "make install"
  exec "make INSTALL_MOD_STRIP=1 DEPMOD=/nodepmod/here modules_install"

  # Mostly from linux-headers PKGBUILD
  # https://gitlab.archlinux.org/archlinux/packaging/packages/linux/-/blob/de68606a2ee79eb1471daedd209a70192c35df14/PKGBUILD
  exec "MODPATH=\"$ROOT/usr/lib/modules/$version/build\""
  exec "rm -f \"$MODPATH\" \"$ROOT/usr/lib/modules/$version/source\""
  exec "mkdir -p \"$MODPATH\" \"$ROOT/usr/src\""
  exec "ln -s \"$MODPATH\" \"$ROOT/usr/lib/modules/$version/source\""
  exec "install -Dt \"$MODPATH\" -m644 .config Makefile Module.symvers System.map localversion.* version vmlinux"
  exec "install -Dt \"$MODPATH/kernel\" -m644 kernel/Makefile"
  exec "install -Dt \"$MODPATH/arch/x86\" -m644 arch/x86/Makefile"
  exec "cp -t \"$MODPATH\" -a scripts"

  # required when STACK_VALIDATION is enabled
  exec "install -Dt \"$MODPATH/tools/objtool\" tools/objtool/objtool"

  # required when DEBUG_INFO_BTF_MODULES is enabled
  exec "install -Dt \"$MODPATH/tools/bpf/resolve_btfids\" tools/bpf/resolve_btfids/resolve_btfids"

  exec "find . -name 'Kconfig*' -exec install -Dm644 {} \"$MODPATH/{}\" \\;"
  exec "find -L \"$MODPATH\" -type l -printf 'Removing %P\\n' -delete"
  exec "find \"$MODPATH\" -type f -name '*.o' -printf 'Removing %P\\n' -delete"

  exec "cp -t \"$MODPATH\" -a include"
  exec "cp -t \"$MODPATH/arch/x86\" -a arch/x86/include"
  exec "install -Dt \"$MODPATH/arch/x86/kernel\" -m644 arch/x86/kernel/asm-offsets.s"

  exec "install -Dt \"$MODPATH/drivers/md\" -m644 drivers/md/*.h"
  exec "install -Dt \"$MODPATH/net/mac80211\" -m644 net/mac80211/*.h"

  # https://bugs.archlinux.org/task/13146
  exec "install -Dt \"$MODPATH/drivers/media/i2c\" -m644 drivers/media/i2c/msp3400-driver.h"

  # https://bugs.archlinux.org/task/20402
  exec "install -Dt \"$MODPATH/drivers/media/usb/dvb-usb\" -m644 drivers/media/usb/dvb-usb/*.h"
  exec "install -Dt \"$MODPATH/drivers/media/dvb-frontends\" -m644 drivers/media/dvb-frontends/*.h"
  exec "install -Dt \"$MODPATH/drivers/media/tuners\" -m644 drivers/media/tuners/*.h"

  # https://bugs.archlinux.org/task/71392
  exec "install -Dt \"$MODPATH/drivers/iio/common/hid-sensors\" -m644 drivers/iio/common/hid-sensors/*.h"

  exec "ln -s \"/usr/lib/modules/$version\" \"$ROOT/usr/src/linux\""

  exec "mv \"$ROOT/boot/vmlinuz\" \"$ROOT/boot/vmlinuz-$version\""
  exec "mv \"$ROOT/boot/System.map\" \"$ROOT/boot/System.map-$version\""
}

func postinstall_linux {
  exec "depmod $version"
}

