name: CI Build

on:
  workflow_call:
    inputs:
      matrix:
        required: true
        type: string
      push:
        required: true
        type: string
      phase_name:
        required: true
        type: string
      image:
        required: false
        type: string
        default: 'builder-repo'
      image_sha:
        required: false
        type: string
        default: ''
      force_build:
        required: false
        type: boolean
        default: false
      llvm:
        required: false
        type: boolean
        default: false
      enable_upterm_ssh:
        required: false
        type: boolean
        default: false
      disable_force_install_all:
        required: false
        type: boolean
        default: false
    secrets:
      GH_PAT:
        required: true
      AWS_ENDPOINT:
        required: true
      AWS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_BUCKET:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.image_sha != '' && format('ghcr.io/kreatolinux/{0}@{1}', inputs.image, inputs.image_sha) || format('ghcr.io/kreatolinux/{0}:latest', inputs.image) }}
      options: --privileged -v /:/opt/host
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(inputs.matrix) }}
    permissions:
      contents: write
    steps:

      - name: Remove useless directories
        run: |        
            for i in /opt/host/$AGENT_TOOLSDIRECTORY /opt/host/opt/google/chrome /opt/host/opt/microsoft/msedge /opt/host/opt/microsoft/powershell /opt/host/opt/pipx /opt/host/usr/lib/mono /opt/host/usr/local/julia* /opt/host/usr/local/lib/android /opt/host/usr/local/lib/node_modules /opt/host/usr/local/share/chromium /opt/host/usr/local/share/powershell /opt/host/usr/share/dotnet /opt/host/usr/share/swift; do
              rm -rf $i || true
            done
        env:
          AGENT_TOOLSDIRECTORY: ${{ runner.tool_cache }}

            

      - name: Get latest workflow run
        id: get-run-id
        run: |
          LATEST_RUN_ID=$(curl -s -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
            "https://api.github.com/repos/kreatolinux/src/actions/workflows/build.yml/runs?status=success&per_page=1" \
            | sed -n 's/.*"id": \([0-9]*\).*/\1/p' | head -1)
          echo "run_id=$LATEST_RUN_ID" >> $GITHUB_OUTPUT

      - uses: actions/download-artifact@v6
        with:
          name: kpkg-amd64-linux-debug
          path: /tmp/kpkg-bin
          github-token: ${{ secrets.GH_PAT }}
          repository: kreatolinux/src
          run-id: ${{ steps.get-run-id.outputs.run_id }}

      - uses: actions/download-artifact@v6
        with:
          name: chkupd-amd64-linux-debug
          path: /tmp/chkupd-bin
          github-token: ${{ secrets.GH_PAT }}
          repository: kreatolinux/src
          run-id: ${{ steps.get-run-id.outputs.run_id }}

      - uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0


      - name: Run chkupd
        run: |
          chmod +x /tmp/chkupd-bin/chkupd
          for package in ${{ matrix.packages }}; do
            if [ -f "$GITHUB_WORKSPACE/$package/run" ]; then
              echo "Running chkupd on $package"
              /tmp/chkupd-bin/chkupd check --package="$package" --repo "$GITHUB_WORKSPACE" --backend repology || true
            fi
          done

      - name: Evaluate usefulness
        id: useless-check
        env:
          FORCE_BUILD: ${{ inputs.force_build }}
        run: |
          set -euo pipefail
          LOCALE=en_US
          mkdir -p /usr/lib/locale
          localedef -i $LOCALE -c -f UTF-8 $LOCALE
          echo "export LANG=$LOCALE.UTF-8" >> /etc/profile
          export LD_LIBRARY_PATH="${LD_LIBRARY_PATH-}"
          . /etc/profile
          export LC_CTYPE=en_US.UTF-8
          export LC_ALL=en_US.UTF-8

          chmod +x /tmp/kpkg-bin/kpkg
          mkdir -p /etc/kpkg/repos/main
          if command -v mountpoint >/dev/null 2>&1 && mountpoint -q /etc/kpkg/repos/main; then
            :
          else
            mount --bind "$GITHUB_WORKSPACE" /etc/kpkg/repos/main
          fi

          /tmp/kpkg-bin/kpkg clean --binaries=true --environment=true

          IS_USELESS="true"
          for package in ${{ matrix.packages }}; do
            /tmp/kpkg-bin/kpkg install "$package" -y --downloadOnly || IS_USELESS="false"
          done

          if [ "$FORCE_BUILD" = "true" ]; then
            IS_USELESS="false"
            for package in ${{ matrix.packages }}; do
              /tmp/kpkg-bin/kpkg clean --binaries --packages "$package"
            done
          fi

          if [ "$IS_USELESS" = "true" ]; then
            mkdir -p /var/cache/kpkg/archives
            touch /var/cache/kpkg/archives/IS_USELESS
          fi

          echo "is_useless=$IS_USELESS" >> $GITHUB_OUTPUT


      - name: Build packages
        if: steps.useless-check.outputs.is_useless != 'true'
        run: |
          LOCALE=en_US
          mkdir -p /usr/lib/locale
          localedef -i $LOCALE -c -f UTF-8 $LOCALE
          echo "export LANG=$LOCALE.UTF-8" >> /etc/profile          
          
          export LD_LIBRARY_PATH="${LD_LIBRARY_PATH-}"
          . /etc/profile
          
          export LC_CTYPE=en_US.UTF-8
          export LC_ALL=en_US.UTF-8

          chmod +x /tmp/kpkg-bin/kpkg
          mkdir -p /etc/kpkg/repos/main
          if command -v mountpoint >/dev/null 2>&1 && mountpoint -q /etc/kpkg/repos/main; then
            :
          else
            mount --bind "$GITHUB_WORKSPACE" /etc/kpkg/repos/main
          fi

          /tmp/kpkg-bin/kpkg clean --binaries=true --environment=true

          if [ "${{ inputs.llvm }}" = "true" ]; then
            /tmp/kpkg-bin/kpkg install llvm -y
            /tmp/kpkg-bin/kpkg set config.Options.cc clang
            sed -i 's/gcc/clang/' /etc/kreato-release
          fi
          
          git config --system --add safe.directory '*'

          for package in ${{ matrix.packages }}; do
                PACKAGES=$(KPKG_ENABLE_DEBUG=0 /tmp/kpkg-bin/kpkg get depends.$package.build 2>&1 || true)
                  
                echo "PACKAGES: $PACKAGES"

                if [ -n "$PACKAGES" ]; then
                   echo '$PACKAGES exist'
                    for dep in $PACKAGES; do
                        echo "trying to install $dep"
                        /tmp/kpkg-bin/kpkg install "$dep" -y || true
                        echo "$dep is installed, continuing"
                    done
                fi
                
                RUNFILE="/etc/kpkg/repos/main/$package/run"
                if [ -f "$RUNFILE" ] && grep -q "BOOTSTRAP_DEPENDS" "$RUNFILE"; then
                    echo "Bootstrapping $package"
                    FORCE_INSTALL_ALL_FLAG=""
                    if [ "${{ inputs.disable_force_install_all }}" != "true" ]; then
                        FORCE_INSTALL_ALL_FLAG="--forceInstallAll=true"
                    fi
                    /tmp/kpkg-bin/kpkg build "$package" --bootstrap --yes --ignorePostInstall $FORCE_INSTALL_ALL_FLAG

                    echo "Bootstrapping $package complete, now removing it from cache"
                    /tmp/kpkg-bin/kpkg clean --binaries --packages "$package"

                    KPKG_EXTRA_ARGS="--useCacheIfAvailable=false"
                fi
          done
          
          FORCE_INSTALL_ALL_FLAG=""
          if [ "${{ inputs.disable_force_install_all }}" != "true" ]; then
              FORCE_INSTALL_ALL_FLAG="--forceInstallAll=true"
          fi
          /tmp/kpkg-bin/kpkg build ${{ matrix.packages }} --yes --ignorePostInstall $FORCE_INSTALL_ALL_FLAG
          cd "$GITHUB_WORKSPACE"
          git pull
          git status

      - name: Commit chkupd changes
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE" || true
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          cd "$GITHUB_WORKSPACE"
          committed_any=false
          for package in ${{ matrix.packages }}; do
            if git status --porcelain | grep -q run; then
              version=$(/tmp/kpkg-bin/kpkg info "$package" 2>/dev/null | awk '/^package version:/ {print $3; exit}')
              if [ -z "$version" ]; then
                version="unknown"
              fi
              echo "Pulling for latest changes..."
              git pull origin master
              echo "Committing updates for $package (version=${version:-unknown})"
              git add "$package"
              git commit -m "${package}: update to ${version:-unknown}"
              committed_any=true
            fi
          done

          if [ "$committed_any" = "true" ]; then
            git push
          else
            echo "No package changes detected"
          fi

      - name: Install MinIO Client
        if: (inputs.push == 'true' || (github.event_name == 'pull_request' && github.event.pull_request.user.login == 'renovate[bot]' && startsWith(github.head_ref || '', 'renovate/')) || github.event_name == 'workflow_dispatch') && steps.useless-check.outputs.is_useless != 'true'
        run: |
          curl -O https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc
          mv mc /bin/
          mc config host rm minio || true
          
      - name: Configure MinIO Client
        if: (inputs.push == 'true' || (github.event_name == 'pull_request' && github.event.pull_request.user.login == 'renovate[bot]' && startsWith(github.head_ref || '', 'renovate/')) || github.event_name == 'workflow_dispatch') && steps.useless-check.outputs.is_useless != 'true'
        run: "mc alias set minio ${{ secrets.AWS_ENDPOINT }} ${{ secrets.AWS_KEY_ID }} ${{ secrets.AWS_SECRET_ACCESS_KEY }} --api s3v4"


      - name: Upload packages through MinIO
        if: (inputs.push == 'true' || (github.event_name == 'pull_request' && github.event.pull_request.user.login == 'renovate[bot]' && startsWith(github.head_ref || '', 'renovate/')) || github.event_name == 'workflow_dispatch') && steps.useless-check.outputs.is_useless != 'true'
        run: |
          upload_with_retry() {
            local retries=3
            local cooldown=5
            local attempt=1

            while [ $attempt -le $retries ]; do
              echo "Upload attempt $attempt of $retries..."

              if [ -d "/var/cache/kpkg/archives" ]; then
                echo "Listing archives directory contents:"
                ls -la /var/cache/kpkg/archives/
                echo "Copying archives..."
                if mc cp --recursive /var/cache/kpkg/archives/* minio/${{ secrets.AWS_BUCKET }}/archives/; then
                  echo "Archives upload successful on attempt $attempt"
                else
                  echo "Archives upload failed on attempt $attempt"
                  if [ $attempt -eq $retries ]; then
                    return 1
                  fi
                fi
              else
                echo "Archives directory does not exist, skipping..."
              fi

              if [ -d "/var/cache/kpkg/sources" ]; then
                echo "Listing sources directory contents:"
                ls -la /var/cache/kpkg/sources/
                echo "Copying sources..."
                if mc cp --recursive /var/cache/kpkg/sources/* minio/${{ secrets.AWS_BUCKET }}/sources/; then
                  echo "Sources upload successful on attempt $attempt"
                else
                  echo "Sources upload failed on attempt $attempt"
                  if [ $attempt -eq $retries ]; then
                    return 1
                  fi
                fi
              else
                echo "Sources directory does not exist, skipping..."
              fi

              return 0

              echo "Waiting $cooldown seconds before retry..."
              sleep $cooldown
              attempt=$((attempt + 1))
            done
          }

          upload_with_retry


      - name: Install dependencies for upterm session
        if: failure() && github.event_name == 'workflow_dispatch' && inputs.enable_upterm_ssh == true
        run: |
          if ! kpkg install tmux -y; then
            kpkg build tmux -y
          fi

          rm -f /bin/sh
          ln -s /bin/bash /bin/sh

      - name: Setup upterm session
        if: failure() && github.event_name == 'workflow_dispatch' && inputs.enable_upterm_ssh == true
        uses: owenthereal/action-upterm@v1
        with:
          limit-access-to-actor: true
          limit-access-to-users: kreatoo
          wait-timeout-minutes: 60
